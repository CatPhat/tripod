@using System.Security.Cryptography
@using System.Text
@using Tripod
@using Tripod.Domain.Security
@using UserConstraints = Tripod.Domain.Security.User.Constraints

@model ChangeUserName

@{
    ViewBag.Title = "User";
}

@section styles
{
    <style>
        .user.jumbotron h1 {
            margin: 0;
            white-space: nowrap;
            -ms-text-overflow: ellipsis;
            -o-text-overflow: ellipsis;
            text-overflow: ellipsis;
            overflow-x: hidden;
            overflow-y: visible;
            display: block;
            line-height: normal;
        }

        .user.jumbotron p.lead {
            margin-bottom: 0;
        }

        .jumbotron img.gravatar {
            width: 64px;
            margin-right: 16px;
        }

        @@media (min-width: 768px) {
            .jumbotron img.gravatar {
                width: 108px;
                margin-right: 20px;
            }
        }

        .nav-header a, .nav > li.nav-header a {
            margin-bottom: 2px;
            border-radius: 5px 5px 0 0;
            border: solid 1px #ddd;
            padding: 4px;
            background-color: #f5f5f5;
            white-space: nowrap;
            -ms-text-overflow: ellipsis;
            -o-text-overflow: ellipsis;
            text-overflow: ellipsis;
            overflow: hidden;
            display: block;
            color: #333;
        }

            .nav-header a:hover, .nav > li.nav-header a:hover {
                background-color: #e7e7e7;
                text-decoration: none;
            }

        .nav-header img.gravatar {
            margin-right: 4px;
        }

        nav.user ul > li > a > i {
            color: #000;
        }

        nav.user ul > li.active > a > i {
            color: #fff;
        }
    </style>
}


<div class="user jumbotron clearfix">
    @Html.Gravatar(128, "pull-left")
    <h1>
        @User.Identity.Name
    </h1>
    <p class="lead">
        <a href="#">
            email@domain.tld
        </a>
    </p>
</div>

<div class="row">
    <div class="col-md-4 hidden-xs hidden-sm">
        <nav class="user">
            <ul class="nav nav-pills nav-stacked" role="navigation">
                <li class="nav-header">
                    <a href="@Url.Action(MVC.User.ById(Html.AuthenticatedUserId()))">
                        @Html.Gravatar(32)
                        <strong>@User.Identity.Name</strong>
                    </a>
                </li>
                <li class="active">
                    <a href="@Url.Action(MVC.User.ById(Html.AuthenticatedUserId()))">
                        <i class="fa fa-user"></i>
                        My Account
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fa fa-envelope"></i>
                        Email Addresses
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fa fa-sign-in"></i>
                        Logins
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fa fa-key"></i>
                        Password
                    </a>
                </li>
            </ul>
        </nav>
        <hr class="hr-md hr-space" />
    </div>
    <div class="col-md-8" role="main">

        <p>
            If you would like to change your @UserConstraints.NameLabel.ToLower(), you can use the text box below to do so.
        </p>

        <form role="form"
              method="POST"
              action="@Url.Action(MVC.User.ChangeName())"
              novalidate
              ng-app="change-username-form"
              ng-controller="App.Security.ChangeUserNameForm.Controller"
              name="changeUserNameForm"
              form-contrib="changeUserNameCtrb"
              form-submitted="true"
              class="form-horizontal">

            @Html.AntiForgeryToken()
            @Html.HttpMethodOverride(HttpVerbs.Put)

            <input type="hidden" name="returnUrl" value="@ViewBag.ReturnUrl" />

            @Html.ValidationSummary(true)
            @{
                const string inputCss = "input-lg";
                const string inputGroupCss = "input-group input-group-lg";
            }

            @* USERNAME INPUT *@
            <div class="form-group form-group-lg @Html.BootstrapValidationCssClassFor(x => x.UserName)"
                 remove-class="has-success has-error"
                 ng-class="changeUserNameCtrb.userName.feedbackCssClass()">

                @* INPUT GROUP COLUMN *@
                <div class="col-md-8">
                    @* LABEL *@
                    <label for="@Html.IdFor(x => x.UserName)" class="control-label">
                        @UserConstraints.NameLabel
                    </label>
                    <small>@Resources.Validation_UserName_AllowedCharacters.Replace("{PropertyName}", "-")</small>
                    <div class="@Html.CssClassWhenNotNullModel(inputGroupCss)"
                         remove-class="@inputGroupCss"
                         ng-class="changeUserNameCtrb.userName.inputGroupCssClass('lg')">
                        <input type="text"
                               class="form-control @inputCss"
                               placeholder="Enter @UserConstraints.NameLabel.ToLower() here"
                               id="@Html.IdFor(x => x.UserName)"
                               name="userName"
                               value="@(Html.ValueFor(x => x.UserName).ToString() != "" ? Html.ValueFor(x => x.UserName) : MvcHtmlString.Create(User.Identity.Name))"
                               ng-init="vm.userName='@(Html.ValueFor(x => x.UserName).ToString() != "" ? Html.ValueForJavaScriptString(x => x.UserName) : MvcHtmlString.Create(User.Identity.Name))'"
                               ng-model="vm.userName"
                               required
                               model-contrib
                               server-error="@Html.ValidationMessageTextFor(x => x.UserName)"
                               server-validate="@Url.Action(MVC.User.ValidateChangeName())"
                               server-validate-data="{ token: vm.token }"
                               server-validate-throttle="400" />

                        <span class="input-group-addon validation @Html.CssClassWhenNullModel("hide")"
                              remove-class="hide"
                              ng-class="vm.userNameInputGroupValidationAddOnCssClass()">
                            <i class="fa fa-fw fa-asterisk default" title="This is a required field"></i>
                            <i class="fa fa-fw fa-times error"></i>
                            <i class="fa fa-fw fa-spinner fa-spin spin-fast spinner"></i>
                            <i class="fa fa-fw fa-exclamation-triangle warning"></i>
                            <i class="fa fa-fw fa-check success"></i>
                        </span>
                    </div>
                </div>

                @* VALIDATION MESSAGES COLUMNS *@
                <div class="col-md-4 validation help-block help-block-horizontal-md under-label hidden-sm hidden-xs">
                    <span tooltip="@Resources.notempty_error.Replace("{PropertyName}", UserConstraints.NameLabel)"
                          tooltip-toggle="vm.isUserNameRequiredError()"
                          tooltip-animation="false"
                          tooltip-placement="right"
                          class="validation-tooltip"></span>
                    <span tooltip="{{ changeUserNameCtrb.userName.error.server }}"
                          tooltip-toggle="vm.isUserNameServerError()"
                          tooltip-animation="false"
                          tooltip-placement="right"
                          class="validation-tooltip"></span>
                    <span ng-class="{ hide: true }">@Html.ValidationMessageFor(x => x.UserName)</span>
                </div>
                <div class="col-md-4 validation help-block hidden-md hidden-lg">
                    <span ng-show="vm.isUserNameRequiredError()" ng-cloak>
                        @Resources.notempty_error.Replace("{PropertyName}", UserConstraints.NameLabel)
                    </span>
                    <span ng-show="vm.isUserNameServerError()" ng-cloak>
                        {{ changeUserNameCtrb.userName.error.server }}
                    </span>
                    <span ng-class="{ hide: true }">
                        @Html.ValidationMessageFor(x => x.UserName)
                    </span>
                </div>
            </div>

            @* FORM SUBMIT BUTTON *@
            <div class="form-group">
                <div class="col-md-12">
                    @{
                        var buttonClass = ViewData.ModelState.IsValid ? null : "btn-danger";
                        var readyClass = ViewData.ModelState.IsValid ? null : "hide";
                        var errorClass = ViewData.ModelState.IsValid ? "hide" : null;
                    }
                    <div class="pull-left">
                        <button type="submit"
                                class="btn btn-primary btn-lg @buttonClass"
                                ng-class="vm.submitCssClass()"
                                ng-disabled="vm.isSubmitDisabled()"
                                remove-class="@buttonClass">
                            <i class="fa fa-fw fa-user @readyClass"
                               remove-class="@readyClass"
                               ng-show="vm.isSubmitReady()"></i>
                            <i class="fa fa-fw fa-exclamation-triangle @errorClass"
                               remove-class="@errorClass"
                               ng-show="vm.isSubmitError()"></i>
                            <i class="fa fa-fw fa-spinner fa-spin spin-fast"
                               ng-show="vm.isSubmitWaiting()" ng-cloak></i>
                            Change @UserConstraints.NameLabel.ToLower()
                        </button>
                        <a href="@Url.Action(MVC.User.ById())" class="nudge-right"
                           ng-click="vm.restoreOrigialUserName($event)"
                           ng-init="vm.originalUserName='@(Html.ValueFor(x => x.UserName).ToString() != "" ? Html.ValueForJavaScriptString(x => x.UserName) : MvcHtmlString.Create(User.Identity.Name))'">
                            Cancel
                        </a>
                    </div>
                    <div class="has-error pull-left nudge-right @errorClass"
                         remove-class="@errorClass"
                         ng-show="vm.isSubmitError()">
                        <div class="help-block">
                            Could not change @UserConstraints.NameLabel.ToLower() due to above error(s).
                        </div>
                    </div>
                </div>
            </div>

        </form>

    </div>
</div>

@section scripts
{
    @{ Html.RenderPartial(MVC.Scripts.Views.Angular); }
    <script src="~/app/security/ChangeUserNameForm.js"></script>
}